# 实现计划: Terminal Plugin

## 概述

本实现计划将终端插件的设计分解为可执行的编码任务，采用增量开发方式，每个任务都建立在前一个任务的基础上。

## 任务

- [x] 1. 项目初始化和基础结构
  - [x] 1.1 创建 Rust 后端项目结构
    - 初始化 Cargo 项目，配置 Cargo.toml 依赖
    - 创建模块目录结构 (rpc/, pty/, ssh/, shell/, utils/)
    - _需求: 9.1, 9.2_
  - [x] 1.2 创建 React 前端项目结构
    - 初始化 npm 项目，配置 package.json 依赖
    - 配置 Vite 构建为 IIFE 格式
    - 配置 TailwindCSS
    - _需求: 9.1_
  - [x] 1.3 创建插件配置文件
    - 创建 plugin.json 插件元数据
    - 创建 config.json 运行时配置
    - _需求: 9.1, 9.3_

- [x] 2. RPC 通信层实现
  - [x] 2.1 实现 RPC 数据类型 (Rust)
    - 定义 TermSize, ConnectionType, SessionStatus, SessionInfo 等类型
    - 实现 Serialize/Deserialize
    - _需求: 3.1, 3.2, 3.3_
  - [x] 2.2 编写 RPC 类型往返属性测试
    - **属性 2: RPC 请求往返一致性**
    - **验证: 需求 3.6**
  - [x] 2.3 实现 RPC 服务器框架 (Rust)
    - 实现 stdin/stdout JSON-RPC 通信
    - 实现请求处理和响应发送
    - 实现通知发送机制
    - _需求: 3.1, 3.2, 3.3_
  - [x] 2.4 编写 RPC 错误响应属性测试
    - **属性 3: RPC 错误响应格式**
    - **验证: 需求 3.5**
  - [x] 2.5 实现 RPC 客户端 (TypeScript)
    - 实现 JSON-RPC 请求发送
    - 实现响应和通知处理
    - 实现 EventEmitter 模式
    - _需求: 3.1, 3.2, 3.3_

- [ ] 3. 检查点 - RPC 层验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 4. PTY 管理器实现
  - [x] 4.1 实现 Shell 检测模块
    - 检测系统默认 shell (SHELL 环境变量)
    - 支持 Windows (COMSPEC)
    - _需求: 8.1_
  - [x] 4.2 实现 PTY 会话管理器
    - 使用 portable-pty 创建 PTY
    - 实现会话创建、输入、调整大小、关闭
    - 实现会话 ID 生成 (UUID)
    - _需求: 1.1, 1.2, 1.3, 1.5, 1.6_
  - [x] 4.3 编写会话 ID 唯一性属性测试
    - **属性 1: 会话 ID 唯一性**
    - **验证: 需求 1.2**
  - [x] 4.4 实现 PTY 输出读取和通知
    - 异步读取 PTY stdout
    - 通过 JSON-RPC 通知发送输出
    - 处理进程退出
    - _需求: 1.4, 1.7_
  - [x] 4.5 编写 PTY 配置传递属性测试
    - **属性 5: PTY 配置传递**
    - **验证: 需求 8.3, 8.4**
  - [x] 4.6 实现 PTY 环境配置
    - 设置 TERM=xterm-256color
    - 传递自定义环境变量
    - 设置工作目录
    - _需求: 8.3, 8.4, 8.5_

- [x] 5. 检查点 - PTY 功能验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 6. OSC 序列处理
  - [x] 6.1 实现 OSC 解析器
    - 解析 OSC 7 (工作目录)
    - 解析 OSC 52 (剪贴板)
    - 处理无效序列
    - _需求: 7.1, 7.2, 7.3_
  - [x] 6.2 编写 OSC 序列处理属性测试
    - **属性 4: OSC 序列处理健壮性**
    - **验证: 需求 7.1, 7.2, 7.3**
  - [x] 6.3 集成 OSC 处理到 PTY 输出流
    - 在输出流中检测 OSC 序列
    - 触发相应的通知
    - _需求: 7.1, 7.2_

- [x] 7. SSH 管理器实现
  - [x] 7.1 实现 SSH 客户端连接
    - 使用 russh 建立 SSH 连接
    - 支持密码认证
    - 支持私钥认证
    - _需求: 2.1, 2.2_
  - [x] 7.2 实现 SSH PTY 通道
    - 创建 PTY 通道
    - 实现输入/输出处理
    - _需求: 2.3, 2.4, 2.5_
  - [x] 7.3 实现 SSH 错误处理
    - 返回描述性错误消息
    - 处理连接失败
    - _需求: 2.6, 2.7_

- [ ] 8. 检查点 - 后端功能验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 9. 错误处理和状态管理
  - [x] 9.1 实现错误类型定义
    - 定义 TerminalError 枚举
    - 实现错误转换
    - _需求: 10.1, 10.2_
  - [x] 9.2 实现会话状态管理
    - 状态转换逻辑
    - 错误状态更新
    - _需求: 10.4_
  - [x] 9.3 编写错误状态一致性属性测试
    - **属性 6: 错误状态一致性**
    - **验证: 需求 10.4, 10.5**

- [x] 10. React 前端 - 终端组件
  - [x] 10.1 实现 TermWrap 类
    - 封装 xterm.js 初始化
    - 加载 FitAddon, SearchAddon, WebLinksAddon
    - 可选加载 WebglAddon
    - _需求: 4.1, 4.5_
  - [x] 10.2 实现终端输入处理
    - 监听 onData 事件
    - 通过 RPC 发送输入
    - _需求: 4.2_
  - [x] 10.3 实现终端输出渲染
    - 监听 RPC 通知
    - 写入 xterm.js
    - _需求: 4.3_
  - [x] 10.4 实现终端大小调整
    - 使用 ResizeObserver
    - 通知后端新尺寸
    - _需求: 4.4_
  - [x] 10.5 实现 Terminal React 组件
    - 组件挂载和卸载
    - 焦点管理
    - _需求: 4.6_

- [x] 11. React 前端 - 多标签页
  - [x] 11.1 实现会话状态管理
    - 创建 session-store
    - 管理多个会话
    - _需求: 5.1, 5.5_
  - [x] 11.2 实现 TerminalTabs 组件
    - 标签页切换
    - 新建/关闭标签页
    - 状态指示器
    - _需求: 5.1, 5.2, 5.3, 5.4_

- [x] 12. React 前端 - 搜索功能
  - [x] 12.1 实现 SearchBar 组件
    - 搜索输入框
    - 上一个/下一个按钮
    - 搜索选项 (大小写、正则)
    - _需求: 6.1, 6.5_
  - [x] 12.2 集成 SearchAddon
    - 执行搜索
    - 高亮匹配
    - 导航结果
    - _需求: 6.2, 6.3, 6.4_

- [x] 13. React 前端 - 连接对话框
  - [x] 13.1 实现 NewConnectionDialog 组件
    - 本地终端选项
    - SSH 连接表单
    - _需求: 1.1, 2.1_

- [-] 14. 检查点 - 前端功能验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 15. 构建和打包
  - [x] 15.1 配置 Rust 交叉编译
    - macOS (arm64, x64)
    - Linux (x64)
    - Windows (x64)
    - _需求: 9.2_
  - [x] 15.2 配置前端构建
    - IIFE 格式输出
    - CSS 提取
    - _需求: 9.1_
  - [x] 15.3 创建构建脚本
    - 自动化构建流程
    - 输出到 plugin/dist/
    - _需求: 9.1, 9.2_

- [ ] 16. 最终检查点
  - 确保所有测试通过
  - 验证插件可以在 ProxyCast 中加载
  - 如有问题请询问用户

## 备注

- 所有任务都是必选的，包括属性测试
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点用于确保增量验证
- 属性测试验证设计文档中定义的正确性属性
